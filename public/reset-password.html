<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script>
        const SUPABASE_URL = 'https://cufglydvzflmzmlfphwm.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN1ZmdseWR2emZsbXptbGZwaHdtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUyOTU5ODgsImV4cCI6MjA4MDg3MTk4OH0.F8gcELQQxO6LbqxO1gqhiZwUjLT1DotLqdAmo1YvEv8';
        
        // 1. Inicializa el cliente solo para esta tarea de captura
        const supabaseCapture = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // 2. Lee el token del hash
        const hash = window.location.hash.substring(1);
        const params = new URLSearchParams(hash);
        const accessToken = params.get('access_token');
        const tokenType = params.get('type');
        
        // Si hay un token de recuperación y la página se está cargando, lo usamos inmediatamente
        if (accessToken && (tokenType === 'recovery' || tokenType === 'signup')) {
            console.log("Token detectado. Intentando setSession inmediatamente...");
            
            // Intentamos establecer la sesión DE INMEDIATO (Plan A, pero ejecutado antes que app.js)
            supabaseCapture.auth.setSession({ access_token: accessToken })
                .then(({ error }) => {
                    if (error) {
                        console.error('Fallo la captura inmediata:', error);
                    } else {
                        console.log('¡Captura inmediata exitosa! Sesión establecida.');
                        // Opcional: Limpiar el hash para que app.js no se confunda
                        // history.replaceState(null, null, ' '); 
                    }
                });
        }
    </script>
    
    <script src="app.js"></script>
</body>
</html>