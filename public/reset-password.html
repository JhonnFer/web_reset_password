<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script>
        const SUPABASE_URL = 'https://cufglydvzflmzmlfphwm.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN1ZmdseWR2emZsbXptbGZwaHdtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUyOTU5ODgsImV4cCI6MjA4MDg3MTk4OH0.F8gcELQQxO6LbqxO1gqhiZwUjLT1DotLqdAmo1YvEv8';
        
        // CAMBIO 1: Quitamos { auth: ... } para usar la configuración por defecto (más estable)
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // Lógica de Captura
        const hash = window.location.hash.substring(1);
        const params = new URLSearchParams(hash);
        
        const accessToken = params.get('access_token');
        const refreshToken = params.get('refresh_token'); // CAMBIO 2: Capturamos Refresh Token
        const tokenType = params.get('type');
        
        console.log("Tokens URL:", accessToken ? "Access: OK" : "Access: Missing", refreshToken ? "Refresh: OK" : "Refresh: Missing");

        if (accessToken && (tokenType === 'recovery' || tokenType === 'signup' || tokenType === 'magiclink')) {
            console.log("Intentando setSession con AMBOS tokens...");
            
            // CAMBIO 3: Pasamos ambos tokens. Esto suele arreglar el 'Auth session missing'
            supabase.auth.setSession({ 
                access_token: accessToken,
                refresh_token: refreshToken || '' // Pasamos string vacío si no llega, para evitar null
            }).then(({ data, error }) => {
                if (error) {
                    console.error('Falló setSession:', error);
                } else {
                    console.log('¡Sesión establecida correctamente!', data.session);
                }
            });
        }
    </script>
    
    <script src="app.js"></script>